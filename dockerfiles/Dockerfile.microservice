# ---------- Stage 1: Build ----------
FROM python:3.11-slim AS builder

ENV POETRY_VIRTUALENVS_CREATE=false \
    POETRY_HOME="/opt/poetry" \
    PATH="$POETRY_HOME/bin:$PATH"

RUN apt-get update && \
    apt-get install -y --no-install-recommends curl build-essential

RUN pip install --upgrade pip && pip install poetry

WORKDIR /app
COPY ./invoice-parsing-microservice/pyproject.toml ./invoice-parsing-microservice/poetry.lock ./
RUN poetry install --no-root --no-interaction --no-ansi

# ---------- Stage 2: Runtime ----------
FROM python:3.11-slim

RUN apt-get update && \
    apt-get install -y --no-install-recommends poppler-utils libglib2.0-0 libsm6 libxext6 libxrender1 && \
    rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY --from=builder /usr/local /usr/local
COPY ./invoice-parsing-microservice .

RUN useradd -m appuser && chown -R appuser /app
USER appuser

EXPOSE 8000
CMD ["uvicorn", "application:app", "--host", "0.0.0.0", "--port", "8000"]
